+ 金牛奖获奖名单 https://www.cs.com.cn/jnj/jnjj/
  + 这只基金获第十八届金牛奖（2021），五年期开放式股票型持续优胜金牛基金



# 第5题

## 忽略除股票外其他所有持仓的收益率，仅加入本金

这是一个非常专业且切中肯綮的问题。

简短的回答是：**对于本项目的目标（分析股票型基金的超额收益和择时能力）而言，将这几项资产的收益率视为 0 是完全可以接受的，也是最合理的简化处理方式。**

请允许我为您逐项评估，并解释为什么这样做是合理的，以及这样做对您的模型会有什么影响。



### 1. 逐项资产评估

- **债券（0.06% 的国债）**
  - **权重**：仅占 0.06%。
  - **分析**：即便国债一天跌了 1%（这在债市是巨大的波动），对整个基金净值的影响也只有 $0.06\% \times 1\% = 0.0006\%$。
  - **结论**：**完全可以忽略**。试图去获取这只特定国债（21国债01）的日度行情数据所花费的精力，与其对模型精度的提升完全不成正比。
- **买入返售金融资产 (Reverse Repos)**
  - **性质**：这本质上是基金把手里的钱短期借给别人（通常是隔夜或7天），对方用债券做抵押。
  - **收益**：年化收益率通常在 1.5% - 2.5% 之间（主要看回购利率如 R001, R007）。
  - **波动**：**极低，接近于 0**。它几乎没有资本利得亏损的风险，收益是线性的利息堆积。
  - **结论**：**视为现金（收益率=0）是可接受的**。虽然它实际上有微薄的利息，但在日度数据的波动面前（股票一天可能波动 3%-5%），这 0.00x% 的日收益可以忽略不计。
- **银行存款和结算备付金 (Cash & Settlement Provisions)**
  - **性质**：就是趴在账上的现金。
  - **收益**：活期存款利率（约 0.35%）或协定存款利率。
  - **波动**：**0**。
  - **结论**：**标准处理方式就是视为 0**。在大多数金融模型（如 CAPM）中，现金类资产本身就被定义为无风险资产的一部分，甚至在计算超额收益时会被减去（$R_i - R_f$）。
- **其他各项资产**
  - **性质**：通常是应收利息、应收股利等会计科目。
  - **结论**：**视为 0**。它们不产生独立的投资回报。



### 2. 关键操作建议：视为 0，但不能“扔掉”

您在处理这约 50 亿的非股票资产时，**最关键的一点是：要保留它们的“权重”，虽然它们的“回报”是 0。**



#### ❌ 错误的做法：

直接忽略这 50 亿，只用那 172 亿股票构建组合。

- **后果**：您的模拟组合会变成 **100% 满仓股票**。这将导致模拟组合的**波动率（Volatility）和 Beta 值虚高**。
- **现象**：当市场跌 1% 时，您的模拟组合跌 1.2%（因为都是高波动的股票），而真实基金只跌 0.8%（因为它有 23% 的钱是现金，没跌）。您会误判基金经理“防守能力强”，其实他只是仓位低。



#### ✅ 正确的做法：

将这 50 亿视为一个**“现金包”**，加入到模拟组合中。

假设：

- 股票组合日收益率 = $R_{stock}$
- 股票资产 = 172 亿
- 非股票资产（现金等） = 50 亿
- 总资产 = 222 亿

计算公式：

$$R_{模拟组合} = R_{stock} \times \frac{172}{222} + 0 \times \frac{50}{222}$$

或者简化为：

$$R_{模拟组合} = R_{stock} \times 0.77$$

### 3. 这样做对结果的微小偏差分析

既然您要把非股票资产设为 0 收益，您需要知道这会带来什么微小的偏差：

1. **对 Beta 的影响（正面）**：非常准确。因为现金的 Beta 本来就是 0，引入这 50 亿的 0 收益资产，能完美地把模拟组合的 Beta 降下来，使其与真实基金（77% 仓位）处于同一个风险水平线上进行公平对比。
2. **对 Alpha 的影响（负面但可接受）**：
   - 真实情况中，这 50 亿可能会产生年化 2% 左右的利息回报。
   - 您假设它回报为 0。
   - **结果**：您的模拟组合业绩会比“真实情况下的被动持有”**略微低一点点**（一年低 0.4% 左右）。
   - **结论**：这意味着您计算出的基金经理 Alpha 可能会被**轻微高估**（因为基准变弱了），但在学术作业或案例分析中，这种程度的系统性偏差通常是被允许的，或者您可以在报告的“局限性讨论”部分提一句即可。

**综上所述：** 请放心地将这几项资产合并视为**“收益率为 0 的现金仓位”**，并将其权重（约 23%）纳入组合计算，这将大大平滑您的模拟曲线，使其与真实基金净值走势高度贴合。



## 用前复权价格反推初始持仓数量

这是一个非常经典且隐蔽的量化回测问题。您通过敏锐的观察发现了数据的异常（持仓市值求和是204亿，但计算出来只有172亿），这非常棒。

这**30亿的差额**并非来自代码逻辑错误，而是来自**“复权价格”与“原始数量”的不匹配**。

### 核心原因：复权价格 (Adjusted Price) < 真实价格

在您的代码中，获取价格时使用了 `adjust_type="pre"`（前复权）：

```python
# 您的代码
adjust_type = "pre"
all_stock = rq.get_price(..., adjust_type=adjust_type)
```

#### 1. 发生了什么？

- **前复权 (Pre-adjusted)** 的原理是将**历史价格**向下调整，以剔除分红、配股、拆细等对股价走势的“断层”影响，从而保证收益率曲线的连续性。
- **2021年年报**中的“持仓市值”是基于**2021年12月31日当天的真实收盘价**计算的。
- **差异来源**：如果一只股票在2022年实施了**分红**或**送转**（例如10送10，或者每股分红0.5元），`ricequant` 为了保持K线连续，会把2021年的价格**按比例调低**。
  - *举例*：某股票2021年底真实价格 **100元**，持仓 **1万股**，真实市值 **100万元**。
  - *假设*：2022年它发生了“10送10”（股价腰斩至50元）。
  - *前复权处理*：为了让曲线平滑，数据源会把2021年底的价格显示为 **50元**（调整后）。
  - *您的计算*：`50元 (复权价)` $\times$ `1万股 (原始数量)` = **50万元**。
  - **结果**：您的计算值直接比真实市值少了一半！

考虑到中欧时代先锋持有的多是蓝筹成长股（如宁德时代、立讯精密等），这些公司在2022年大概率有分红或送转行为，全组合累积下来，**“复权折价”导致总市值缩水了30亿（约15%）**是非常合理的。

#### 2. 这会带来什么后果？

如果不修正这个问题，不仅初始金额对不上，**更严重的是模拟组合的权重（Weights）会被扭曲**：

- 分红/送转越多的股票，其复权价被“打折”得越厉害，在您模拟组合里的权重就越低。
- 这意味着您的模拟组合**不再是**基金经理真实的持仓结构了。



### ✅ 解决方案：校准持仓数量

我们不能使用“不复权”的价格（因为那样会导致2022年的收益率曲线出现虚假的暴跌）。

**最完美的解法是：** 利用年报里准确的“持仓市值”，反推在“前复权价格体系”下的“模拟持仓数量”。

**请用以下代码替换原本的 `hold_matrix` 构建逻辑：**

```python
# ==========================================
# 修正逻辑：使用“模拟数量”代替“原始数量”
# ==========================================

# 1. 提取 2021-12-31 当天的复权价格向量
price_20211231 = price_matrix.loc['2021-12-31']

# 2. 准备年报里的真实市值数据
# 确保索引是股票代码，且与 price_20211231 对齐
real_market_value = stock_hold['持仓市值（元）']

# 3. 计算“复权体系下的模拟持仓数量”
# 公式：模拟数量 = 真实市值 / 2021年底的复权价格
# 这样：模拟数量 * 2021复权价 = 真实市值 (204亿) -> 完美对齐
simulated_shares = real_market_value / price_20211231

# 处理可能出现的缺失值（比如某些股票在矩阵里没有价格）
simulated_shares = simulated_shares.fillna(0)

# 4. 构建新的 hold_matrix (用于后续 dot 乘法)
# 注意：simulated_shares 是一个 Series，我们需要把它变成与 price_matrix 列匹配的形状
# 因为 dot 乘法要求: price (TxN) dot hold (N) -> (T)
# 所以我们可以直接用这个 Series 作为 hold_vector

hold_vector = simulated_shares

# ==========================================
# 重新计算日度回报
# ==========================================
# 矩阵乘法：Price Matrix (TxN) * Hold Vector (N)
simulated_daily_return = price_matrix.dot(hold_vector).to_frame(name="Stock_Asset")

# 接下来的步骤保持不变...
# ... 加上非权益资产 ...
simulated_daily_return["Net Value"] = simulated_daily_return["Stock_Asset"] + non_equity_sum
simulated_daily_return["Daily Return"] = simulated_daily_return["Net Value"].pct_change() # * 100 根据需要

print("修正后的2021-12-31股票持仓市值：")
print(f"{simulated_daily_return.iloc[0]['Stock_Asset']:,.2f} 元 (应接近 204 亿)")
```

### 总结

这个修正操作做了两件事：

1. **对齐了初始金额**：您的 `Stock_Asset` 将回到准确的 **204亿**，总净值也会回到 **223亿** 左右（误差极小）。
2. **修正了权重扭曲**：通过市值反推数量，确保了每个股票在组合里的权重与年报真实权重完全一致，从而保证后续计算的 $\alpha$ 和 $\beta$ 是准确的。



Q:

这个模拟持仓相较于真实持仓肯定偏大，用它来计算未来一年所有的涨跌，从而评估基金择时能力，真的合适吗？

使用模拟持仓是否只有对齐初始市值的作用？如果是，直接不使用模拟持仓、也不对齐，对结果有实质影响吗？

此外，你说如果直接调取不复权的价格，2022年初会出现暴跌。那真实的基金净值会同样出现暴跌吗？如果不跌，原因是什么？我该如何处理这个问题？



A:

这是一个非常深刻且触及量化回测核心机制的好问题。你对数据“失真”的担忧非常敏锐，但请放心，**使用“模拟持仓”不仅合适，而且是唯一正确的做法**。

下面我将分三点彻底解答你的疑虑，并解释“暴跌”背后的原理。

------

### 1. 为什么“虚高的模拟持仓”是完全合适的？

**核心逻辑：我们关心的是“涨跌幅（Return）”，而不是“绝对股价（Price）”。**

虽然计算出的“模拟持仓股数”比年报里的“真实股数”多（因为复权价通常低于真实价），但这一增一减刚好抵消，**数学上是等价的**。

- **真实世界**：
  - 股价 100元 $\times$ 100股 = **10,000元**
  - 第二天涨 10%（股价变为 110元）：市值变为 **11,000元**。
- **复权数据世界（模拟）**：
  - 复权价 50元 $\times$ 200股（模拟股数） = **10,000元**
  - 第二天涨 10%（复权价变为 55元）：市值变为 $55 \times 200$ = **11,000元**。

结论：

无论用哪套数据，组合的最终收益率（Daily Return）是完全一样的。用“模拟持仓”计算出来的涨跌幅，完全可以用来评估基金经理的择时能力。它就像是把一张披萨切成8块还是4块，披萨的总量（市值）和味道（收益率）并没有改变。

------

### 2. 不使用模拟持仓（不对齐初始市值）会有实质影响吗？

**会有巨大影响，且会导致错误的结果。**

校准的本质作用**不是**为了对齐那几百亿的总金额，而是为了**校准权重（Weights）**。

如果直接用 `真实持仓数量` $\times$ `复权价格`，你会遇到一个致命问题：**分红越多的股票，权重被压缩得越厉害。**

- **举例**：
  - **股票A（高分红）**：真实价100元，复权价50元（打5折）。
  - **股票B（无分红）**：真实价100元，复权价100元（无变化）。
  - 基金经理在2021年底实际上是**等权买入**（各买1万元）：
    - 持有A：100股。
    - 持有B：100股。
- **如果你不进行校准（直接用真实股数）：**
  - 你的模拟组合里：
    - 股票A市值：$100股 \times 50元 = 5,000元$
    - 股票B市值：$100股 \times 100元 = 10,000元$
  - **后果**：你的模型认为基金经理重仓了B（占67%），轻仓了A（占33%）。
  - **实质影响**：如果2022年股票A大涨，股票B大跌，你的模型会算出一个“大跌”的结果，而真实的基金经理其实没亏那么多。**这会直接导致你对Alpha和择时能力的误判。**

**结论**：必须通过`真实市值 / 复权价格`反推模拟数量，以保证**股票A和股票B在起跑线上的权重比例与真实基金完全一致**。

------

### 3. 真实净值为什么不暴跌？如果不复权会怎样？

这是初学者最容易困惑的地方。

#### A. 为什么不复权的数据（原始价格）会暴跌？

假设某股票价格100元，明天进行“10送10”（每人送你同样多的股数）。

- **价格**：会瞬间变成 50元（除权）。
- **股数**：你手里的股票数量瞬间翻倍。
- **如果不复权**：你的代码只读取到价格从 100 变成了 50，却**不知道**手里的股数翻倍了（因为你的代码里持仓股数是锁死不变的）。
- **结果**：代码计算出该股票当日亏损 -50%。这就是你看到的“暴跌”。

#### B. 真实的基金净值为什么不暴跌？

因为基金公司的会计系统是**实时动态**的：

- 当股价从 100 掉到 50 那一瞬间，基金后台的记账系统里，该股票的**持仓数量自动翻倍了**。
  - **<span style="color:red;">因此，进入2022年（股票完成分红）的那一刻，真实世界的基金持仓实际上也变成了模拟持仓</span>**（准确地说，“模拟持仓”的数量，等于真实基金在【完成当年度所有分红送转后】的持仓数量）
    - 前复权价格：数据商为了让K线平滑，把历史（6月1日之前）的股价全部打折了，假装分红早就发生过了。**模拟持仓，就是基金在“经历了一切分红送转”后的最终形态**
- 或者如果是分红（股价掉），基金账上会多出一笔**“应收股利”的现金**。
- **总资产**：$50元 \times 200股 = 10,000元$。
- **结果**：总资产不变，净值自然是一条平滑的曲线，不会暴跌。

#### C. 你该如何处理？

因为我们无法在Python代码里去模拟每一只股票每一天的分红、送转、配股的具体会计操作（那太复杂了），所以量化界的通用做法就是**“以前复权价格为准”**：

1. **使用前复权价格**：这消除了价格的突变（把历史价格抹平了）。
2. **使用模拟持仓数量**：既然价格被“抹平”了（变小了），我们就把持仓数量“虚拟放大”。

最终方案：

继续坚持你现在的做法——使用 adjust_type="pre" 获取复权数据，并使用 stock_hold['持仓市值'] / price_matrix.iloc[0] 计算模拟持仓。这是处理这个问题的行业标准答案。